{% extends "layouts/base.html" %}

{% block title %} UI Tables {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <!-- ============================================================== -->
    <!-- Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <div class="page-breadcrumb">
        <div class="row align-items-center">
            <div class="col-md-6 col-8 align-self-center">
                <h3 class="page-title mb-0 p-0">Nova Inscrição</h3>
                <div class="d-flex align-items-center">
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Container fluid  -->
    <!-- ============================================================== -->
    <div class="container-fluid">
        <!-- ============================================================== -->
        <!-- Start Page Content -->
        <!-- ============================================================== -->
        <div class="row">
            <!-- column -->
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Nova Inscrição</h4>
                        <h6 class="card-subtitle">Preencha os detalhes da inscrição</h6>
                        <form id="createInscricaoForm">
                            <div class="mb-3">
                                <label for="conferencia" class="form-label">Conferência</label>
                                <select class="form-control" id="conferencia" name="conferencia" required>
                                    {% for conferencia in conferencias %}
                                        <option value="{{ conferencia.id }}">{{ conferencia.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="responsavel" class="form-label">Responsável</label>
                                    <input type="text" class="form-control" id="responsavel" name="responsavel" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="cidade" class="form-label">Cidade</label>
                                    <input type="text" class="form-control" id="cidade" name="cidade" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="estado" class="form-label">Estado</label>
                                    <select class="form-control" id="estado" name="estado" required>
                                        <option value="">Selecione um estado</option>
                                        <option value="Acre">Acre</option>
                                        <option value="Alagoas">Alagoas</option>
                                        <option value="Amapá">Amapá</option>
                                        <option value="Amazonas">Amazonas</option>
                                        <option value="Bahia">Bahia</option>
                                        <option value="Ceará">Ceará</option>
                                        <option value="Distrito Federal">Distrito Federal</option>
                                        <option value="Espírito Santo">Espírito Santo</option>
                                        <option value="Goiás">Goiás</option>
                                        <option value="Maranhão">Maranhão</option>
                                        <option value="Mato Grosso">Mato Grosso</option>
                                        <option value="Mato Grosso do Sul">Mato Grosso do Sul</option>
                                        <option value="Minas Gerais">Minas Gerais</option>
                                        <option value="Pará">Pará</option>
                                        <option value="Paraíba">Paraíba</option>
                                        <option value="Paraná">Paraná</option>
                                        <option value="Pernambuco">Pernambuco</option>
                                        <option value="Piauí">Piauí</option>
                                        <option value="Rio de Janeiro">Rio de Janeiro</option>
                                        <option value="Rio Grande do Norte">Rio Grande do Norte</option>
                                        <option value="Rio Grande do Sul">Rio Grande do Sul</option>
                                        <option value="Rondônia">Rondônia</option>
                                        <option value="Roraima">Roraima</option>
                                        <option value="Santa Catarina">Santa Catarina</option>
                                        <option value="São Paulo">São Paulo</option>
                                        <option value="Sergipe">Sergipe</option>
                                        <option value="Tocantins">Tocantins</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label for="pg_dinheiro" class="form-label">Pg Dinheiro</label>
                                    <input type="number" step="0.01" class="form-control" id="pg_dinheiro" name="pg_dinheiro" required value="0.00">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="pg_deposito" class="form-label">Pg Depósito</label>
                                    <input type="number" step="0.01" class="form-control" id="pg_deposito" name="pg_deposito" required value="0.00">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="pg_transferencia" class="form-label">Pg Transferência</label>
                                    <input type="number" step="0.01" class="form-control" id="pg_transferencia" name="pg_transferencia" required value="0.00">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="pg_cheque" class="form-label">Pg Cheque</label>
                                    <input type="number" step="0.01" class="form-control" id="pg_cheque" name="pg_cheque" required value="0.00">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label for="pg_total" class="form-label">Pg Total</label>
                                    <input type="number" step="0.01" class="form-control" id="pg_total" name="pg_total" readonly value="0.00">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="total_inscricoes" class="form-label">Total Inscrições</label>
                                    <input type="number" step="0.01" class="form-control" id="total_inscricoes" name="total_inscricoes" readonly value="0.00">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="pg_pendencias" class="form-label">Pendências</label>
                                    <input type="number" step="0.01" class="form-control" id="pg_pendencias" name="pg_pendencias" readonly value="0.00">
                                </div>
                            </div>
                            <script>
                                document.getElementById('pg_dinheiro').addEventListener('input', updateTotal);
                                document.getElementById('pg_deposito').addEventListener('input', updateTotal);
                                document.getElementById('pg_transferencia').addEventListener('input', updateTotal);
                                document.getElementById('pg_cheque').addEventListener('input', updateTotal);

                                function updateTotal() {
                                    var dinheiro = parseFloat(document.getElementById('pg_dinheiro').value) || 0;
                                    var deposito = parseFloat(document.getElementById('pg_deposito').value) || 0;
                                    var transferencia = parseFloat(document.getElementById('pg_transferencia').value) || 0;
                                    var cheque = parseFloat(document.getElementById('pg_cheque').value) || 0;

                                    var total = dinheiro + deposito + transferencia + cheque;
                                    document.getElementById('pg_total').value = total.toFixed(2);
                                    updatePendencias()
                                }
                            </script>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="observacoes" class="form-label">Observações</label>
                                    <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                                </div>
                            </div>

                            <h5 class="card-title">Participantes</h5>
                            <button id="addParticipant" class="btn btn-small btn-dark">Adicionar participante</button>
                            <br>
                            <br>
                            <div id="participants">
                                <div class="row participant">
                                    <div class="col-md-2 mb-3">
                                        <label for="nome" class="form-label">Nome</label>
                                        <input type="text" class="form-control" id="nome_0" name="nome" required>
                                    </div>
                                    <div class="col-md-1 mb-3">
                                        <label for="idade" class="form-label">Idade</label>
                                        <input type="number" class="form-control" id="idade_0" name="idade" required>
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label for="sexo" class="form-label">Sexo</label>
                                        <select class="form-control" id="sexo_0" name="sexo" required>
                                            <option value="M">M</option>
                                            <option value="F">F</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="tipo_inscricao" class="form-label">Tipo Inscrição</label>
                                        <select class="form-control" id="tipo_inscricao_0" name="tipo_inscricao" required>
                                            <option value="Completa Adulto">Completa</option>
                                            <option value="Participação">Participação</option>
                                            <option value="Serviço">Serviço</option>
                                            <option value="Serviço">Isento</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label for="valor" class="form-label">Valor</label>
                                        <input type="number" step="0.01" class="form-control" id="valor_0" name="valor" required value="0.00" oninput="updateTotalInscricoes()">
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.getElementById('addParticipant').addEventListener('click', function() {
                                    var participantsDiv = document.getElementById('participants');
                                    var newParticipant = participantsDiv.getElementsByClassName('participant')[0].cloneNode(true);
                                    // Clear the input values in the cloned node
                                    var inputs = newParticipant.getElementsByTagName('input');
                                    var selects = newParticipant.getElementsByTagName('select');
                                    var newId = participantsDiv.getElementsByClassName('participant').length;
                                    
                                    // Add new Ids
                                    for (var i = 0; i < inputs.length; i++) {
                                        inputs[i].value = '';
                                        inputs[i].id = inputs[i].id.replace(/_\d+$/, '_' + newId);
                                    }
                                    for (var i = 0; i < selects.length; i++) {
                                        selects[i].selectedIndex = 0;
                                        selects[i].id = selects[i].id.replace(/_\d+$/, '_' + newId);
                                    }
                                    participantsDiv.appendChild(newParticipant);
                                });

                                function updateTotalInscricoes() {
                                    var participants = document.getElementsByClassName('row participant');
                                    var totalInscricoes = 0;
                                    for (var i = 0; i < participants.length; i++) {
                                        var valor = parseFloat(participants[i].querySelector('#valor_'+(i)).value) || 0;
                                        totalInscricoes += valor;
                                    }
                                    document.getElementById('total_inscricoes').value = totalInscricoes.toFixed(2);
                                    updatePendencias()
                                }

                                function updatePendencias(){
                                    var totalInscricoes = parseFloat(document.getElementById('total_inscricoes').value) || 0;
                                    var pgTotal = parseFloat(document.getElementById('pg_total').value) || 0;
                                    var pendencias = pgTotal - totalInscricoes;
                                    document.getElementById('pg_pendencias').value = pendencias.toFixed(2);
                                    if (pendencias < 0) {
                                        document.getElementById('pg_pendencias').style.color = "red";
                                    } else if (pendencias > 0) {
                                        document.getElementById('pg_pendencias').style.color = "blue";
                                    } else {
                                        document.getElementById('pg_pendencias').style.color = "green";
                                    }
                                }
                            
                            </script>
                            <br>
                            <br>
                            <div class="text-center">
                                <button type="submit" class="btn btn-success">Criar Inscrição</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- ============================================================== -->
        <!-- End PAge Content -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Right sidebar -->
        <!-- ============================================================== -->
        <!-- .right-sidebar -->
        <!-- ============================================================== -->
        <!-- End Right sidebar -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Container fluid  -->
    <!-- ============================================================== -->

{% endblock content %}

{% block javascripts %}
<script>
    document.getElementById("createInscricaoForm").addEventListener("submit", function(event) {
        event.preventDefault();
        
        var form = event.target;
        var formData = new FormData(form);
        var jsonData = {};
        
        for (var pair of formData.entries()) {
            jsonData[pair[0]] = pair[1];
        }
        
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/create_conference");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(jsonData));
        
        xhr.onload = function() {
            if (xhr.status === 200 || xhr.status === 201) {
                window.location.href = "/";
            }
        };
    });
</script>
{% endblock javascripts %}